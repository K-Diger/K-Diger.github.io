---

title: Spring Web MVC - 웹 서버, 웹 애플리케이션서버, 서블릿, 멀티 쓰레드

date: 2023-01-09
categories: [Spring, MVC]
tags: [Spring, MVC]
layout: post
toc: true
math: true
mermaid: true

---

# 웹 서버란?

HTTP 기반으로 동작하고 정적 리소스를 제공하는 것에 부가기능을 처리할 수 있는 서버를 말한다.

예시로는 NGINX, APACHE가 있다.


# 웹 애플리케이션 서버란? (WAS)

HTTP 기반으로 동작하고, 웹 서버 기능을 포함하여 정적 리소스를 제공하는 것 뿐만 아니라, 프로그램 코드를 실행하여 애플리케이션 로직을 수행할 수 있다.

동적 HTML, HTTP API(JSON), 서블릿, JSP, 스프링 MVC가 웹 애플리케이션 서버에서 동작한다.

예시로는 톰캣, Jetty, Undertow 등이 있다.

# WAS가 웹 애플리케이션에 최적인 것 같은데 그럼 WAS 하나로만 다 해결이 되나?

WAS 하나로는 버겁다. 과부화가 발생할 확률이 굉장히 높다.

WAS가 HTML,CSS,JS 같이 단순 정적 컨텐츠를 내려주는 역할은 금방 할 수 있지만

비즈니스 로직을 처리하고 DB와 소통하는 기능은 꽤나 비용이 큰 작업이다.

그렇기 때문에 WAS 앞단에, WS 를 배치하여 앞서 언급한 정적 컨텐츠들을 내려줄 수 있도록 전담하는 구성하고 WAS는 비즈니스 로직에만 전담하는 것이 좋고

정적 리소스가 많이 요구되면 WS만 증설하고 애플리케이션 리소스가 많이 요구되면 WAS를 증설하는 등 유연한 확장이 가능해지는 모델이 될 수 있다.

# 서블릿이란? 그리고 이건 왜 필요한거야??

![img.png](https://github.com/K-Diger/K-Diger.github.io/blob/main/images/%EC%84%9C%EB%B2%84%EA%B0%80%ED%95%B4%EC%95%BC%ED%95%A0%EC%9D%BC.png?raw=true)

위 그림과 같이 실제로 웹 애플리케이션 서버가 해줘야하는 일은 저렇게 산더미만큼 있다.

실제로 개발을 해보면 알겠듯이 우리는 비즈니스 로직을 만드는데에도 몸이 부족하다고 느껴질만큼 비용이 소요된다.

근데 여기서 비즈니스 로직을 작성하는 외의 웹 애플리케이션 서버가 해야하는 모든 기능을 만들어야한다면 어떻게 될까?

이러한 의문에서 나오는 해결책이 **서블릿** 이라는 개념이다.

## 서블릿 맛보기
```java
@WebServlet(name = "helloServlet", urlPatterns = "/hello")
public class HelloServlet extends HttpServlet {
    @Override
    protected void service(HttpServletRequest request, HttpServletResponse response) {
        // 비즈니스로직
    }
}
```
위 코드가 서블릿의 어느 조각이다. HTTP 요청/응답을 코드 단에서 편리하게 다룰 수 있도록 해주는 내용이 가장 와닿는 장점일 것이다.

하지만 HTTP 스펙을 아예몰라선 좀 그렇다 당연하게도 HTTP 배경지식은 꽤나 깔고 들어가야 더 정교한 웹 애플리케이션 서버를 만들 수 있다.

# 서블릿 컨테이너란?

앞서 간단하게 작성한 서블릿 코드들을 관리해주는 컨테이너로, 특정 요청이 들어오면 적합한 서블릿에 매핑해주며 생명주기까지 관리해주는 역할을 한다.

물론 우리가 직접 이 컨테이너를 개발할 필요는 없다.

서블릿 컨테이너는 객체 생성 + 초기화 + 호출 + 종료의 생명주기를 관리한다.

또한 서블릿 객체는 싱글톤으로 관리되는데, 요청이 올 때마다 서블릿객체를 생성해준다는 것 자체가 너무나도 비효율적이기 때문이다.

따라서 최초 로딩 시점에 서블릿 객체를 미리 만들어서 재활용한다. 그리고 모든 요청은 동일한 서블릿 객체 인스턴스에 접근한다.

서블릿은 동시 요청에 대한 멀티 쓰레드 처리를 지원한다!

![img.png](https://github.com/K-Diger/K-Diger.github.io/blob/main/images/%EC%84%9C%EB%B8%94%EB%A6%BF%EC%9D%84%ED%98%B8%EC%B6%9C%ED%95%98%EB%8A%94%EA%B2%83%EC%9D%80.png?raw=true)

정리하자면 서블릿의 도움을 받아 손쉽게 웹 애플리케이션과 클라이언트간의 HTTP 통신을 할 수 있게되는 것이다.

근데 서블릿은 도대체 누가 호출할까?

# 쓰레드

바로 앞서 말한 궁금증의 답은 쓰레드이다. 쓰레드가 서블릿을 호출한다.

쓰레드란, **애플리케이션 코드를 하나하나 순차적으로 실행**하는 것으로 Java Main Method를 실행하면 main이라는 이름의 쓰레드가 실행된다.

쓰레드가 없으면 Application이 동작할 수 없으며, 쓰레드는 한번에 하나의 코드 라인만 수행하는 특징이 있어 동시 처리가 필요하다면 쓰레드를 추가적으로 생성해야한다.

## 매 요청마다 쓰레드를 생성하는 것이 정말 좋을까?

### 장점

동시 요청을 처리할 수 있게 되고

서버의 리소스가 허용할 때 까지 처리가능하며

하나의 쓰레드가 지연되고 있어도 나머지 쓰레드는 정상적으로 동작한다.

### 단점

쓰레드는 생성 비용 자체는 매우 비싸다.

요청이 올 때마다 쓰레드를 생성하면 응답 속도가 늦어진다.

쓰레드는 컨텍스트 스위칭 비용이 발생한다.

쓰레드 생성에 제한이 없어 서버의 리소스를 초과할 수 있다.


장/단점을 비교해봤으니 결정을 내리면 된다. 과연 쓰레드를 매 요청마다 생성하는게 좋을까? 웬만한 웹 애플리케이션 서버에서는 절대 아니라고 본다.

# 쓰레드 풀

앞서 말한대로 쓰레드를 매 요청마다 생성하는거는 WAS의 니즈에 맞지 않는다.

따라서 이 방법외로 멀티 쓰레드를 제공할 수 있는 방법으로 미리 쓰레드를 만들어 놓은 후 필요할 때마다 가져가서 사용하는 방식이 있는데

이 미리 만들어진 쓰레드를 보관하는 곳을 쓰레드 풀이라고 한다.

무한정으로 다중 쓰레드를 수용할 순 없으나 그 쓰레드 양은 일반적인 WAS 규모에서는 충분하다.

만약에 쓰레드 풀에 남은 쓰레드가 없다면 요청을 거절하거나, 특정 시간만큼 대기하도록 조치하는 방식을 사용한다.

# 쓰레드 풀 알아야 할 것.

WAS의 주요 튜닝 포인트는 최대 쓰레드 수이다.

최대 쓰레드 수를 낮게 설정하면, 동시 요청에 대해서 서버 리소스(CPU, RAM)는 여유롭지만 요청 처리는 너무나 느려진다.

최대 쓰레드 수를 높게 설정하면, 동시 요청에 대해서 서버 리소스가 버티지 못하고 종료된다.

장애 발생 시 클라우드 기반의 WAS라면 서버부터 늘리고, 이후에 튜닝을 해야한다.

쓰레드 풀의 적정 숫자는 어떻게 알 수 있을까?

애플리케이션 로직의 복잡도, CPU, Memory 리소스에 따라 모두 다르기 때문에

Apache ab, JMiter, nGrinder 와 같은 성능 테스트 툴을 이용하여 측정하는 것이 좋다.

# WAS가 멀티 쓰레드를 알아서 해준다!

다만 개발 중에 공유변수 및 싱글톤 객체를 주의해서 사용해야함을 꼭 잊지말자.

